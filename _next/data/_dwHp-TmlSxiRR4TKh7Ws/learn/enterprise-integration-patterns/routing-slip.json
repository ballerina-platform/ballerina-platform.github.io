{"pageProps":{"tagline":"Route message according to an order.","desc":"Route the message to the next component according to the sequence of processing steps specified in a routing slip.","category":"Message Routing","index":33,"helps":"Ballerina excels in enabling seamless integration of diverse services with inherent concurrent support, as well as in data binding, type enforcement, and native error-handling capabilities.","tags":["Routing Slip","Message Channel","Message Endpoint","Message Router"],"link":"https://www.enterpriseintegrationpatterns.com/patterns/messaging/RoutingTable.html","code":"<pre class=\"shiki github-light\" style=\"background-color: #fff\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/http;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">PaymentRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> mobileNumber;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> customerName;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">float</span><span style=\"color: #24292E\"> totalAmount;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> storeCode;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {}[] items;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">PaymentStatus</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> status;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">float</span><span style=\"color: #24292E\"> totalPoints;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">float</span><span style=\"color: #24292E\"> redeemedAmount;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">float</span><span style=\"color: #24292E\"> totalAmount;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    } details;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">Message</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\">PaymentRequest;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> storeCode;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[] routingSlip </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> [];</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">Points</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">float</span><span style=\"color: #24292E\"> loyaltyPoints </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">0.0</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">float</span><span style=\"color: #24292E\"> mobilePoints </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">0.0</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">service</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">/api/v1</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">on</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> http:Listener(</span><span style=\"color: #005CC5\">8080</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">resource</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">post</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">payments</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">PaymentRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">request</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> PaymentStatus</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[] routingSlip </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">lookupMessageSlip</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">request</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        Message message </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">...</span><span style=\"color: #24292E\">request, routingSlip</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> routingSlip};</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        Points points </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {};</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> message.routingSlip.</span><span style=\"color: #6F42C1\">length</span><span style=\"color: #24292E\">() </span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">0</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            http</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client pointHandler </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> (</span><span style=\"color: #032F62\">&quot;http://localhost:8081/loyaltyPoints&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #005CC5\">json</span><span style=\"color: #24292E\"> payload </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                storeCode</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> message.storeCode,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                mobileNumber</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> message.mobileNumber,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                routingSlip</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> message.routingSlip</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            points </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> pointHandler</span><span style=\"color: #D73A49\">-&gt;/</span><span style=\"color: #24292E\">points.</span><span style=\"color: #6F42C1\">post</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">payload</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">checkout</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">message</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">points</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">checkout</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">Message</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">message</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">Points</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">points</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> PaymentStatus {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">float</span><span style=\"color: #24292E\"> totalPoints </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> points.loyaltyPoints </span><span style=\"color: #D73A49\">+</span><span style=\"color: #24292E\"> points.mobilePoints;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        status</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;SUCCESS&quot;</span><span style=\"color: #24292E\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        details</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            totalPoints</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> totalPoints,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            redeemedAmount</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> totalPoints * </span><span style=\"color: #005CC5\">50</span><span style=\"color: #24292E\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            totalAmount</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> message.totalAmount - (</span><span style=\"color: #E36209\">totalPoints</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">50</span><span style=\"color: #24292E\">)</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">lookupMessageSlip</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">PaymentRequest</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">request</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[]</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    http</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client openLoyalty </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> (</span><span style=\"color: #032F62\">&quot;http://openloyalty.com.balmock.io&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">anydata</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> customer </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> openLoyalty</span><span style=\"color: #D73A49\">-&gt;/</span><span style=\"color: #24292E\">api</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">[request.storeCode]</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">member</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">&#39;check</span><span style=\"color: #D73A49\">/</span><span style=\"color: #6F42C1\">get</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[] routingSlip </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> [];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> customer </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">anydata</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        routingSlip.</span><span style=\"color: #6F42C1\">push</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;CustomerLoyaltyPoints&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">isRegisteredToPointsService</span><span style=\"color: #24292E\">(request.mobileNumber) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        routingSlip.</span><span style=\"color: #6F42C1\">push</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;MobilePoints&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> routingSlip;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">isRegisteredToPointsService</span><span style=\"color: #24292E\">(</span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">mobileNumber</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">boolean</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    http</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client openLoyalty </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> (</span><span style=\"color: #032F62\">&quot;http://mob.points.hub.com.balmock.io&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">anydata</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> memberCheck </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> openLoyalty</span><span style=\"color: #D73A49\">-&gt;/</span><span style=\"color: #24292E\">api</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">[mobileNumber]</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">member</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">&#39;check</span><span style=\"color: #D73A49\">/</span><span style=\"color: #6F42C1\">get</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> memberCheck </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">false</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">true</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span></code></pre>","name":" Routing Slip","content":"import ballerina/http;\n\ntype PaymentRequest record {|\n    string mobileNumber;\n    string customerName;\n    float totalAmount;\n    string storeCode;\n    record {}[] items;\n|};\n\ntype PaymentStatus record {|\n    string status;\n    record {\n        float totalPoints;\n        float redeemedAmount;\n        float totalAmount;\n    } details;\n|};\n\ntype Message record {|\n    *PaymentRequest;\n    string storeCode;\n    string[] routingSlip = [];\n|};\n\ntype Points record {\n    float loyaltyPoints = 0.0;\n    float mobilePoints = 0.0;\n};\n\nservice /api/v1 on new http:Listener(8080) {\n    resource function post payments(PaymentRequest request) returns PaymentStatus|error {\n        string[] routingSlip = check lookupMessageSlip(request);\n        Message message = {...request, routingSlip: routingSlip};\n        Points points = {};\n        if message.routingSlip.length() > 0 {\n            http:Client pointHandler = check new (\"http://localhost:8081/loyaltyPoints\");\n            json payload = {\n                storeCode: message.storeCode,\n                mobileNumber: message.mobileNumber,\n                routingSlip: message.routingSlip\n            };\n            points = check pointHandler->/points.post(payload);\n        }\n        return checkout(message, points);\n    }\n}\n\nfunction checkout(Message message, Points points) returns PaymentStatus {\n    float totalPoints = points.loyaltyPoints + points.mobilePoints;\n    return {\n        status: \"SUCCESS\",\n        details: {\n            totalPoints: totalPoints,\n            redeemedAmount: totalPoints * 50,\n            totalAmount: message.totalAmount - (totalPoints * 50)\n        }\n    };\n}\n\nfunction lookupMessageSlip(PaymentRequest request) returns string[]|error {\n    http:Client openLoyalty = check new (\"http://openloyalty.com.balmock.io\");\n    anydata|error customer = openLoyalty->/api/[request.storeCode]/member/'check/get();\n    string[] routingSlip = [];\n    if customer is anydata {\n        routingSlip.push(\"CustomerLoyaltyPoints\");\n    }\n    if check isRegisteredToPointsService(request.mobileNumber) {\n        routingSlip.push(\"MobilePoints\");\n    }\n    return routingSlip;\n}\n\nfunction isRegisteredToPointsService(string mobileNumber) returns boolean|error {\n    http:Client openLoyalty = check new (\"http://mob.points.hub.com.balmock.io\");\n    anydata|error memberCheck = openLoyalty->/api/[mobileNumber]/member/'check/get();\n    return memberCheck is error ? false : true;\n}\n"},"__N_SSG":true}